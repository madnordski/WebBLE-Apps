<!-- TrackVoltageCar
     This is used to read voltage from the Track Voltage Car.  Just
     turn on the circuit inside the car, put it on the track, move it
     along and monitor voltage changes with your phone.

     J. King 27 Dec 2025

     To run this as the front end to the ESP32 ServoCar visit:
     https://madnordski.github.io/WebBLE-Apps/TrackVoltageCar.html
-->
<!DOCTYPE html>
<html>
<head>
    <title>Track Voltage Car</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
     #acquireBtn.active {
	 background-color: #ffd966;
     }
     
     #freezeBtn.active {
	 background-color: #ffd966;
     }
     
     #readoutRow {
	 display: flex;
	 justify-content: center;
	 gap: 3rem;
	 margin-top: 1rem;
     }
     
     .readout {
	 text-align: center;
     }
     
     .readoutValue {
	 font-size: 3.5rem;
	 font-weight: bold;
	 line-height: 1;
     }
     
     .readoutUnits {
	 font-size: 1rem;
	 color: #666;
     }
     
     .readout.diff.positive .readoutValue {
	 color: #0a8a0a;   /* green */
     }
     
     .readout.diff.negative .readoutValue {
	 color: #c00000;   /* red */
     }
     
     .readout.diff.zero .readoutValue {
	 color: #333;
     }
     
     #contextRow {
	 text-align: center;
	 margin-top: 0.5rem;
	 font-size: 0.9rem;
	 color: #444;
     }
     
     #controlRow {
	 text-align: center;
	 margin-top: 1rem;
     }
    </style>
</head>
<body>
    <h1 align="center">Track Voltage Car</h1>
    <p align="center">BLE:<button id="connectBleButton"> üîó </button>
	<button id="disconnectBleButton"> ‚ùå </button>
    </p>
    <p align="center">BLE state: <strong>
	<span id="bleState" style="color:#d13a30;">Disconnected</span>
    </strong></p>
  <!-- <h2 align="center"><span id="valueContainer">NaN</span></h2> -->
  <div id="readoutRow">
      <div class="readout">
	  <div class="readoutValue">
	      <span id="valueContainer">NaN</span>
	  </div>
	  <div class="readoutUnits">V</div>
      </div>

      <div class="readout diff">
	  <div class="readoutValue">
	      <span id="diffContainer">‚Äî</span>
	  </div>
	  <div class="readoutUnits">ŒîV</div>
      </div>
  </div>
  <div id="contextRow">
      <span>Last avg:</span>
      <strong><span id="avgContainer">‚Äî</span> V</strong>
      &nbsp;&nbsp;|&nbsp;&nbsp;
      <span>Reference:</span>
      <strong><span id="refContainer">‚Äî</span> V</strong>
  </div>
  <div id="controlRow">
      <button onclick="zoomIn()" id="zoomInBtn">üîç‚ûï</button>
      <button onclick="acquire()" id="acquireBtn">Acquire</button>
      <button onclick="getReference()" id="referenceBtn">Reference</button>
      <button onclick="zoomOut()" id="ZoomOutBtn">üîé‚ûñ</button>      
  </div>

  <canvas id="voltageChart" width="400" height="200"></canvas>
  <p align="center">
  <button onclick="scrollBack()">‚óÄ</button>
  <button onclick="scrollForward()">‚ñ∂</button>
  <button onclick="toggleFreeze()" id="freezeBtn">Freeze</button>
  <button id="exportCsvBtn">Download CSV</button>
  <br>
  <font size="-2">$Revision: 1.15 $</font>
  </p>
</body>

<!-- This is where the magic happens -->
<script>
 // DOM Elements
 const connectButton = document.getElementById('connectBleButton');
 const disconnectButton = document.getElementById('disconnectBleButton');
 const retrievedValue = document.getElementById('valueContainer');
 const latestValueSent = document.getElementById('valueSent');
 const bleStateContainer = document.getElementById('bleState');
 const timestampContainer = document.getElementById('timestamp');
 
 //Define BLE Device Specs
 var deviceName ='TrackVoltageCar';
 var bleService = '1357632d-42e8-44f5-a5c8-6ff6103bf0ea';
 var sensorAspect = 'c96ff38c-f327-4dbb-a1e2-41c4219c3c59';
 
 //Global Variables to Handle Bluetooth
 var bleServer;
 var bleServiceFound;
 var sensorAspectFound;

 // Plot setup code
 const MAX_HISTORY = 3600;
 const MAX_WINDOW = 20;        // 20-second window
 const history = [];
 let viewStart = 0;
 let frozen = false;
 let sampleIndex = 0;
 let timeZero = performance.now();
 let referenceValue = null;
 let lastAcquiredAve = null;
 const zoomLevels = [0, 0.75, 0.5, 0.25, 0.12];
 const maxZoomLevels = zoomLevels.length-1;
 const yMin = 0.0;
 const yMax = 20.0;
 let zoomLevel = 0;
 
 document.getElementById("exportCsvBtn").addEventListener("click",
							  exportHistoryToCSV);
 
 const ctx = document.getElementById('voltageChart').getContext('2d');

 // for the plot we ue Chart.js
 
 const voltageChart = new Chart(ctx, {
     type: 'line',
     data: {
	 datasets: [{
	     label: 'Track Voltage (RMS)',
	     data: history,
	     borderWidth: 2,
	     tension: 0.1,          // slight smoothing
	     pointRadius: 2
	 }]
     },
     options: {
	 parsing: false,
	 animation: false,
	 scales: {
	     // to keep ticks from changing we set the count and stepSize
	     x: {
		 type: 'linear',
		 ticks: {
		     count: 20,
		     stepSize: 1,
		     autoSkip: false
		 },
		 title: {
		     display: true,
		     text: 'Sample'
		 }
	     },
	     y: {
		 min: yMin,            // adjust as you like
		 max: yMax,
		 title: {
		     display: true,
		     text: 'Volts'
		 }
	     }
	 }
     }
 });
 
 // Connect Button (search for BLE Devices only if BLE is available)
 connectButton.addEventListener('click', (event) => {
     if (isWebBluetoothEnabled()){
         connectToDevice();
     }
 });
 
 // Disconnect Button
 disconnectButton.addEventListener('click', disconnectDevice);
 
 // Check if BLE is available in your Browser
 function isWebBluetoothEnabled() {
     if (!navigator.bluetooth) {
         console.log("Web Bluetooth API is not available in this browser!");
         bleStateContainer.innerHTML =
	     "Web Bluetooth API is not available in this browser!";
     }
     console.log('Web Bluetooth API supported in this browser.');
     return true
 }
 
 // Connect to BLE Device and Enable Notifications
 function connectToDevice(){
     // console.log('Initializing Bluetooth...');
     navigator.bluetooth.requestDevice({
         filters: [{name: deviceName}],
         optionalServices: [bleService]
     })
              .then(device => {
		  console.log('Device Selected:', device.name);
		  bleStateContainer.innerHTML =
		      'Connected to device ' + device.name;
		  bleStateContainer.style.color = "#24af37";
		  device.addEventListener('gattservicedisconnected',
					  onDisconnected);
		  return device.gatt.connect();
              })
              .then(gattServer =>{
		  bleServer = gattServer;
		  console.log("Connected to GATT Server");
		  return bleServer.getPrimaryService(bleService);
              })
              .then(service => {
		  bleServiceFound = service;
		  console.log("Service discovered:", service.uuid);
		  return service.getCharacteristic(sensorAspect);
              })
              .then(characteristic => {
		  console.log("Characteristic discovered:",
			      characteristic.uuid);
		  sensorAspectFound = characteristic;
		  characteristic.addEventListener('characteristicvaluechanged',
						  handleCharacteristicChange);
		  characteristic.startNotifications();
		  console.log("Notifications Started.");
		  return characteristic.readValue();
              })
              .then(value => {
		  //console.log("Read value: ", value);
		  const decodedValue = new TextDecoder().decode(value);
		  //console.log("Decoded value: ", decodedValue);
		  retrievedValue.innerHTML = decodedValue;
              })
     //.catch(error => {
     //    console.log('Error: ', error);
     //})
 }
 
 function onDisconnected(event){
     console.log('Device Disconnected:', event.target.device.name);
     bleStateContainer.innerHTML = "Device disconnected";
     bleStateContainer.style.color = "#d13a30";
     
     connectToDevice();
 }

 let volts = null;
 
 function handleCharacteristicChange(event){
     const newValueReceived = new TextDecoder().decode(event.target.value);
     volts = parseFloat(newValueReceived);
     //console.log("Characteristic value changed: ", newValueReceived);
     valueContainer.textContent = volts.toFixed(2);
     // no value, nothing to do
     if ( isNaN(volts) ) return;
     
     if ( referenceValue !== null ) {
	 const diff = volts - referenceValue;
	 diffContainer.textContent =
	     (diff >= 0 ? "+" : "") + diff.toFixed(2);
	 const diffReadout = document.querySelector(".readout.diff");
	 diffReadout.classList.remove("positive", "negative", "zero");
	 if ( Math.abs(diff) < 0.005 ) {
	     diffReadout.classList.add("zero");
	 }
	 else if ( diff > 0 ) {
	     diffReadout.classList.add("positive");
	 }
	 else {
	     diffReadout.classList.add("negative");
	 }
     }
     else {
	 diffContainer.textContent = "--"
     }

     const t = (performance.now() - timeZero) / 1000;

     history.push({
	 x: sampleIndex++,
	 y: volts,
	 i: t,
     });

     if ( history.length > MAX_HISTORY ) {
	 history.shift();
	 //viewStart = Math.max(0, viewStart - 1);
     }

     // chart update unless frozen
     if ( frozen ) return;

     viewStart = Math.max(0, history.length - MAX_WINDOW);
     updateChartView();
 }

 function updateChartView() {
     const slice = history.slice(viewStart, viewStart + MAX_WINDOW);
     const yMin = voltageChart.options.scales.y.min;
     const yMax = voltageChart.options.scales.y.max;
     const clipped = slice.map(p => ({
         x: p.x,
         y: Math.min(Math.max(p.y, yMin), yMax)
     }));
     
     voltageChart.data.datasets[0].data = clipped;
     voltageChart.update('none');
 }

 function toggleFreeze() {
     if ( !frozen ) {
	 freezeBtn.textContent = "Unfreeze";
	 freezeBtn.classList.add("active");
	 frozen = true;
     }
     else {
	 freezeBtn.textContent = "Freeze";
	 freezeBtn.classList.remove("active");
	 frozen = false;
     }
 }

 function scrollBack() {
     if ( !frozen ) toggleFreeze();
     viewStart = Math.max(0, viewStart - 1);
     updateChartView();
 }

 function scrollForward() {
     if ( !frozen ) toggleFreeze();
     viewStart = Math.min(
	 history.length - MAX_WINDOW,
	 viewStart + 1
     );
     updateChartView();
 }
 
 function disconnectDevice() {
     console.log("Disconnect Device.");
     if (bleServer && bleServer.connected) {
         if (sensorAspectFound) {
             sensorAspectFound.stopNotifications()
				      .then(() => {
					  console.log("Notifications Stopped");
					  return bleServer.disconnect();
				      })
				      .then(() => {
					  console.log("Device Disconnected");
					  bleStateContainer.innerHTML =
					      "Device Disconnected";
					  bleStateContainer.style.color =
					      "#d13a30";
					  
				      })
				      .catch(error => {
					  console.log("An error occurred:",
						      error);
				      });
         } else {
             console.log("No characteristic found to disconnect.");
         }
     } else {
         // Throw an error if Bluetooth is not connected
         console.error("Bluetooth is not connected.");
         window.alert("Bluetooth is not connected.")
     }
 }
 
 function exportHistoryToCSV() {
     if (!history.length) {
	 alert("No data to export");
	 return;
     }

     // Collect all unique keys, in stable order
     const keys = [];
     history.forEach(row => {
	 Object.keys(row).forEach(k => {
	     if (!keys.includes(k)) keys.push(k);
	 });
     });

     // Build CSV rows
     const lines = [];
     lines.push(keys.join("\t")); // header

     history.forEach(row => {
	 const line = keys.map(k => {
	     const val = row[k];
	     if (val === undefined) return "";
	     if (typeof val === "number") return val;
	     return `"${String(val).replace(/"/g, '""')}"`;
	 });
	 lines.push(line.join("\t"));
     });

     // Create downloadable blob
     const csv = lines.join("\n");
     const blob = new Blob([csv], { type: "text/csv" });
     const url = URL.createObjectURL(blob);

     // Trigger download
     const a = document.createElement("a");
     a.href = url;
     a.download = `track_voltage_${new Date().toISOString()}.csv`;
     a.click();

     URL.revokeObjectURL(url);
 }

 let isAcquiring = false;
 let acquireStartIndex = null;
 let lastAcquiredAvg = null;

 function acquire() {
     if ( !isAcquiring ) {
	 // START acquisition
	 acquireStartIndex = history.length;
	 isAcquiring = true;
	 acquireBtn.textContent = "Stop Acquire";
	 acquireBtn.classList.add("active");	 
     }
     else {
	 // STOP acquisition
	 const acquireEndIndex = history.length;
	 
	 if (acquireEndIndex > acquireStartIndex) {
	     lastAcquiredAvg = getAverage(acquireStartIndex, acquireEndIndex);
	     avgContainer.textContent = lastAcquiredAvg.toFixed(2);	     
	 }
	 else {
	     // No samples collected
	     lastAcquiredAvg = null;
	     avgContainer.textContent = "‚Äî";
	 }

	 isAcquiring = false;
	 acquireStartIndex = null;
	 acquireBtn.textContent = "Acquire";
	 acquireBtn.classList.remove("active");
     }
 }

 function getReference() {
     if ( isAcquiring ) {
	 acquire();
     }
     if (lastAcquiredAvg !== null) {
	 referenceValue = lastAcquiredAvg;
	 refContainer.textContent = referenceValue.toFixed(2);
     }
 }

 function zoomIn() {
     zoomLevel = Math.min(zoomLevel+1, maxZoomLevels);
     zoom(zoomLevel);
 }

 function zoomOut() {
     zoomLevel = Math.max(zoomLevel-1, 0);
     zoom(zoomLevel);
 }

 function zoom(level) {
     let window = zoomLevels[level];
     if ( window == 0 ) {
	 voltageChart.options.scales.y.min = yMin;
	 voltageChart.options.scales.y.max = yMax;
     }
     else {
	 voltageChart.options.scales.y.min = Math.max(0, volts - window);
	 voltageChart.options.scales.y.max = Math.max(0, volts + window);
     }
 }
 
 function getAverage(startIndex, endIndex) {
     let sum = 0;
     let count = 0;

     for (let i = startIndex; i < endIndex; i++) {
	 sum += history[i].y;
	 count++;
     }

     return count > 0 ? sum / count : NaN;
 }

</script>
</html>
